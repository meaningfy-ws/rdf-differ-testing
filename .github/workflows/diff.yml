name: RDF Diff

on:
  push:
    paths:
      - 'files/**'
  workflow_dispatch:

jobs:
  rdf-diff:
    runs-on: ubuntu-latest

    steps:
    - name: Check out this repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Required for committing back

    - name: Clone rdf-differ-ws (but exclude from commits)
      run: |
        git clone --branch feature/DIF1-14_cli-client https://github.com/meaningfy-ws/rdf-differ-ws.git
        echo "rdf-differ-ws/" >> .gitignore
        echo "‚úÖ Added rdf-differ-ws/ to .gitignore"

    - name: Start Traefik for user-friendly network routing
      run: |
        cd rdf-differ-ws
        make start-traefik
        echo "üîé Running Docker containers after start-traefik:"
        docker ps

    - name: Start RDF Differ Docker services
      run: |
        cd rdf-differ-ws
        make start-services
        echo "üîé Running containers after start-services:"
        docker ps

    - name: Wait for RDF Differ services to be ready
      run: |
        echo "‚è≥ Waiting 5 seconds for rdf-differ-ws container group (via Traefik) to be ready..."
        sleep 5

    - name: Perform full RDF diff and report workflow
      env:
        FILE1: ${{ vars.FILE1 || 'files/first.ttl' }}
        FILE2: ${{ vars.FILE2 || 'files/second.ttl' }}
        OUTDIR: ${{ vars.OUTDIR || 'diff-output' }}
        AP: ${{ vars.AP || 'owl-core-en-only' }}
        TEMPLATE: ${{ vars.TEMPLATE || 'html' }}
      run: |
        echo "FILE1: $FILE1"
        echo "FILE2: $FILE2"
        echo "OUTDIR: $OUTDIR"
        echo "AP: $AP"
        echo "TEMPLATE: $TEMPLATE"

        cd rdf-differ-ws
        bash ./bash/rdf-differ.sh --old ../$FILE1 --new ../$FILE2 --output ../$OUTDIR --profile $AP --template $TEMPLATE
        
        echo "üîé First few lines of the diff report:"
        head ../$OUTDIR/diff.${TEMPLATE}

    - name: Stop RDF Differ services and Traefik
      run: |
        cd rdf-differ-ws
        make stop-services
        make stop-traefik
        echo "üîé Running containers after stopping services and Traefik:"
        docker ps

    - name: Commit and push diff result
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add diff-output
        git commit -m "chore(ci-auto): add RDF diff report for latest updates" || echo "No changes to commit"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
